//////////////////////////////////////////////////////////////////////////////////////
// Mystic OS Copyright (c) Wojciech Figat
// The software is provided 'as is'. 
// The original author is not responsible for any harm which may result from use of this software or its source code
// See also my 3d game engine --> http://celelej.com
//////////////////////////////////////////////////////////////////////////////////////

// Include
#include "FileSystem.h"

/////////////////////////////////////////////////////////////////////////////////////
// Fat Library
/////////////////////////////////////////////////////////////////////////////////////

// File System
extern FileSystem Fat;

#if OS_DEST_FILESYSTEM == OS_FATFS
	
	// Attach library
	#include "..\FatFs\ff.h"
	#include "..\SPI_SD_Card\SPI_MSD_Driver.h"
	
#else

	#error "Invalid FileSystem"
	
#endif

/////////////////////////////////////////////////////////////////////////////////////
// Check if a drive is available. Returns True or False.
/////////////////////////////////////////////////////////////////////////////////////
Byte OS_FS_Available(void)
{
	#if OS_DEST_PLATFORM == OS_LPC17xx
	
		return !_card_insert();
	
	#endif
}

/////////////////////////////////////////////////////////////////////////////////////
// FileSystem General Initialization
/////////////////////////////////////////////////////////////////////////////////////
Byte OS_FS_Init(void)
{
	#if OS_DEST_FILESYSTEM == OS_FATFS
	
		return (Byte)f_mount(0, &Fat);
	
	#endif
}

/////////////////////////////////////////////////////////////////////////////////////
// Close FileSystem and release all resources
/////////////////////////////////////////////////////////////////////////////////////
Byte OS_FS_Exit(void)
{
	#if OS_DEST_FILESYSTEM == OS_FATFS
	
		return (Byte)f_mount(0 , &Fat);
	
	#endif
}

/////////////////////////////////////////////////////////////////////////////////////
// Open or create file
/////////////////////////////////////////////////////////////////////////////////////
Byte OS_FS_Open(File* file, const Char* path, Byte flags)
{
	#if OS_DEST_FILESYSTEM == OS_FATFS
	
		return (Byte)f_open(file , path , flags);
	
	#endif
}

/////////////////////////////////////////////////////////////////////////////////////
// Delete existing file or directory
/////////////////////////////////////////////////////////////////////////////////////
Byte OS_FS_Delete(const Char* path)
{
	#if OS_DEST_FILESYSTEM == OS_FATFS
	
		return (Byte)f_unlink(path);
	
	#endif
}

/////////////////////////////////////////////////////////////////////////////////////
// Create new directory
/////////////////////////////////////////////////////////////////////////////////////
Byte OS_FS_CreateDir(const Char* path)
{
	#if OS_DEST_FILESYSTEM == OS_FATFS
	
		return (Byte)f_mkdir(path);
	
	#endif
}

/////////////////////////////////////////////////////////////////////////////////////
// Read data from file
/////////////////////////////////////////////////////////////////////////////////////
Byte OS_FS_Read(File* file, void* buffer, Word size)
{
	#if OS_DEST_FILESYSTEM == OS_FATFS
	
		UINT br;
		return (Byte)f_read (file, buffer, size, &br);
	
	#endif
}

/////////////////////////////////////////////////////////////////////////////////////
// Move file pointer of a file
/////////////////////////////////////////////////////////////////////////////////////
Byte OS_FS_Seek(File* file, Word pos)
{
	#if OS_DEST_FILESYSTEM == OS_FATFS
	
		return (Byte)f_lseek(file, pos);
	
	#endif
}

/////////////////////////////////////////////////////////////////////////////////////
// Close file
/////////////////////////////////////////////////////////////////////////////////////
Byte OS_FS_Close(File* file)
{
	#if OS_DEST_FILESYSTEM == OS_FATFS
	
		return (Byte)f_close(file);
	
	#endif
}

/////////////////////////////////////////////////////////////////////////////////////
// Open Direcory
/////////////////////////////////////////////////////////////////////////////////////
Byte OS_FS_OpenDir(Directory* dir, const Char* path)
{
	#if OS_DEST_FILESYSTEM == OS_FATFS
	
		return (Byte)f_opendir(dir,path);
	
	#endif
}

/////////////////////////////////////////////////////////////////////////////////////
// Read direcory item
/////////////////////////////////////////////////////////////////////////////////////
Byte OS_FS_ReadDir(Directory* dir, FileInfo *info)
{
	#if OS_DEST_FILESYSTEM == OS_FATFS
	
		return (Byte)f_readdir(dir,info);
	
	#endif
}

/////////////////////////////////////////////////////////////////////////////////////
// Get file info
/////////////////////////////////////////////////////////////////////////////////////
Byte OS_FS_FileInfo(const Char* path, FileInfo* info)
{
	#if OS_DEST_FILESYSTEM == OS_FATFS
	
		return (Byte)f_stat(path, info);

	#endif
}

/////////////////////////////////////////////////////////////////////////////////////
// Write data to file
/////////////////////////////////////////////////////////////////////////////////////
Byte OS_FS_Write(File* file, const void* buffer, Word size)
{
	#if OS_DEST_FILESYSTEM == OS_FATFS
	
		UINT br;
		return (Byte)f_write(file , buffer, size, &br);
	
	#endif
}

/////////////////////////////////////////////////////////////////////////////////////
// Get Fat informations
/////////////////////////////////////////////////////////////////////////////////////
Byte OS_FS_GetFatInfo(FatInfo *info)
{
	#if OS_DEST_FILESYSTEM == OS_FATFS
	
		Byte res;
		FileSystem *fs;
		Word fre_clust;
		
		res = (Byte)f_getfree("0:", &fre_clust, &fs);
		
		info->FatType = fs->fs_type;
		info->TotalSpace = ((fs->n_fatent - 2) * fs->csize );
		info->FreeSpace = (fre_clust * fs->csize);
		
		return res;
	
	#endif
}

/////////////////////////////////////////////////////////////////////////////////////
// Truncate file
/////////////////////////////////////////////////////////////////////////////////////
Byte OS_FS_Truncate (File *file)
{
	#if OS_DEST_FILESYSTEM == OS_FATFS
	
		return (Byte)f_truncate(file);
	
	#endif
}

/////////////////////////////////////////////////////////////////////////////////////
// Flush cached data to the file
/////////////////////////////////////////////////////////////////////////////////////
Byte OS_FS_Flush (File *file)
{
	#if OS_DEST_FILESYSTEM == OS_FATFS
	
		return (Byte)f_sync(file);
	
	#endif
}

/////////////////////////////////////////////////////////////////////////////////////
// Set attribute of the file or directory
/////////////////////////////////////////////////////////////////////////////////////
Byte OS_FS_SetAttribute(const Char* path, Byte attribute)
{
	#if OS_DEST_FILESYSTEM == OS_FATFS
	
		return (Byte)f_chmod(path, attribute, FILE_ATTRIBUTE_READ_ONLY | FILE_ATTRIBUTE_ARCHIVE | FILE_ATTRIBUTE_SYSTEM | FILE_ATTRIBUTE_HIDDEN);
	
	#endif
}

/////////////////////////////////////////////////////////////////////////////////////
// Set timestamp of the file or directory
/////////////////////////////////////////////////////////////////////////////////////
Byte OS_FS_SetTime(const Char* path, const FileInfo* timestamp)
{
	#if OS_DEST_FILESYSTEM == OS_FATFS
	
		return (Byte)f_utime(path, timestamp);
	
	#endif
}

/////////////////////////////////////////////////////////////////////////////////////
// Rename or move file
/////////////////////////////////////////////////////////////////////////////////////
Byte OS_FS_Rename(const Char* Fold, const Char* Fnew)
{
	#if OS_DEST_FILESYSTEM == OS_FATFS
	
		return (Byte)f_rename(Fold, Fnew);
	
	#endif
}
